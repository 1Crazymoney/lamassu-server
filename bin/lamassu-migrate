#!/usr/bin/env node
const FileStore = require('migrate/lib/file-store')

const _ = require('lodash/fp')
const path = require('path')
require('dotenv').config({ path: path.resolve(__dirname, '../.env') })

const db = require('../lib/db')
const migrate = require('../lib/migrate')
const { asyncLocalStorage, defaultStore } = require('../lib/async-storage')

const MIGRATE_STATE_PATH = process.env.MIGRATE_STATE_PATH

const createMigration = `CREATE TABLE IF NOT EXISTS migrations (
  id serial PRIMARY KEY,
  data json NOT NULL
)`

const select = 'select * from migrations limit 1'

const getMigrateFile = () => {
  return new Promise((resolve, reject) => {
    new FileStore(MIGRATE_STATE_PATH).load((err, store) => {
      if (err) return reject(err)
      return resolve(store)
    })
  })
}

const store = defaultStore()
asyncLocalStorage.run(store, () => {
  db.none(createMigration)
    .then(() => Promise.all([db.oneOrNone(select), getMigrateFile()]))
    .then(([qResult, migrateFile]) => {
      process.env.SKIP_SERVER_LOGS = !(qResult && _.find(({ title }) => title === '1572524820075-server-support-logs.js', qResult.data.migrations ?? []))
      if (!qResult && migrateFile) {
        return db.none('insert into migrations (id, data) values (1, $1)', [migrateFile])
      }
    })
    .then(() => migrate.run())
    .then(() => {
      console.log('DB Migration succeeded.')
      process.exit(0)
    })
    .catch(err => {
      console.error('DB Migration failed: %s', err)
      process.exit(1)
    })
})
