#!/usr/bin/env node

'use strict'

var fs = require('fs')
var createServer = require('../lib/app.js')
var argv = require('minimist')(process.argv.slice(2))

var options

try {
  options = JSON.parse(fs.readFileSync('/etc/lamassu.json'))
} catch (err) {
  try {
    options = JSON.parse(fs.readFileSync('./lamassu.json'))
  } catch (err2) {
    console.log('Missing configuration file /etc/lamassu.json -- exiting.')
    process.exit(1)
  }
}

process.env.DATABASE_URL = options.postgresql

var port = process.env.PORT || 3000

if (!argv.http) {
  options.https = {
    key: fs.readFileSync(options.certKey),
    cert: fs.readFileSync(options.certPath)
  }
}

options.mock = argv.mock

var server = createServer(options)

server.listen(port, function () {
  console.log('lamassu-server listening on port ' + port + ' ' +
    (argv.http ? '(http)' : '(https)'))
})
