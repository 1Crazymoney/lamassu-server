#!/usr/bin/env node

'use strict'

var fs = require('fs')
const os = require('os')
var path = require('path')
var createServer = require('../lib/app.js')
var argv = require('minimist')(process.argv.slice(2))

var options

try {
  options = JSON.parse(fs.readFileSync('/etc/lamassu.json'))
} catch (err) {
  try {
    const homePath = path.resolve(os.homedir(), '.lamassu', 'lamassu.json')
    options = JSON.parse(fs.readFileSync(homePath))
  } catch (err2) {
    console.log('Missing configuration file -- exiting.')
    process.exit(1)
  }
}

process.env.DATABASE_URL = options.postgresql

var port = process.env.PORT || 3000
var httpOnly = options.httpOnly || argv.http

if (!httpOnly) {
  options.https = {
    key: fs.readFileSync(options.certKeyPath),
    cert: fs.readFileSync(options.certPath)
  }
}

options.mock = argv.mock

var server = createServer(options)

server.listen(port, function () {
  console.log('lamassu-server listening on port ' + port + ' ' +
    (httpOnly ? '(http)' : '(https)'))
})
